<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Exames</title>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        .loader {
            border-top-color: #0d9488; /* teal-600 */
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-btn.active {
            border-bottom-color: #0d9488; /* teal-600 */
            color: #0d9488;
            font-weight: 600;
        }
        @media print {
            body {
                background-color: white !important;
            }
            body * {
                visibility: hidden;
            }
            #report-output, #report-output * {
                visibility: visible;
            }
            .tab-buttons-container, #action-buttons-container, #main-header, #main-footer, #input-section, #disclaimer-section {
                display: none !important;
            }
            #report-output {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
            .tab-content {
                display: block !important;
                margin-bottom: 2rem;
                padding: 0 !important;
            }
            h2, h3 {
                padding-top: 1rem;
                border-top: 1px solid #ccc;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header id="main-header" class="text-center mb-8 flex flex-col items-center">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-wide">MISSIONARY MEDICAL CARE</h1>
            <h2 class="text-lg md:text-xl font-semibold text-teal-700 mt-2 tracking-wide">TELESSAÚDE MISSIONÁRIA ATÉ OS CONFINS DA TERRA</h2>
            <p class="text-md text-gray-600 mt-4">Interpreta exames laboratoriais, oferecendo insights precisos, sem substituir diagnósticos médicos.</p>
        </header>

        <main>
            <!-- Sección de Inserción de Datos -->
            <div id="input-section" class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <form id="lab-form">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900 border-b border-gray-200 pb-3">Seus Exames</h2>
                    
                    <div>
                        <label for="exam-text" class="block text-sm font-medium text-gray-700">Copie e cole aqui o seu relatório de exame</label>
                        <textarea id="exam-text" rows="12" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-teal-500 focus:border-teal-500" placeholder="Pode colar o texto do seu exame diretamente nesta caixa. Por exemplo: Hemoglobina: 11.2 g/dL (Ref: 12-16), Leucócitos: 8500 /mm³ (Ref: 4000-11000)..."></textarea>
                    </div>

                    <div class="mt-6">
                         <label for="outros_dados" class="block text-sm font-medium text-gray-700">Sintomas ou preocupações principais (opcional)</label>
                         <textarea id="outros_dados" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Ex: Sinto muito cansaço e tenho tido dores de cabeça."></textarea>
                    </div>
                    
                    <div id="action-buttons-container" class="mt-8 pt-6 border-t border-gray-200 flex flex-col md:flex-row justify-center items-center gap-4 flex-wrap">
                        <button type="button" id="generate-report-btn" class="w-full sm:w-auto bg-teal-600 hover:bg-teal-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-teal-300">
                            Analisar Meus Exames
                        </button>
                        <button type="button" id="print-report-btn" class="w-full sm:w-auto bg-slate-600 hover:bg-slate-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-slate-300 flex items-center justify-center gap-2" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2v-6a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
                            Imprimir Relatório
                        </button>
                        <button type="button" id="whatsapp-share-btn" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-green-300 flex items-center justify-center gap-2" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.398 1.905 6.316l-.205.283-1.217 4.459 4.525-1.187-.282-.192z"/></svg>
                            Partilhar no WhatsApp
                        </button>
                        <button type="button" id="clear-form-btn" class="w-full sm:w-auto bg-white hover:bg-gray-100 text-gray-700 font-bold py-2.5 px-6 rounded-lg shadow-md border border-gray-300 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-gray-200">
                            Limpar
                        </button>
                    </div>
                </form>
            </div>

            <div id="loading-section" class="text-center my-10" style="display: none;">
                <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto"></div>
                <p class="mt-4 text-lg text-gray-600">Analisando seus dados... Por favor, aguarde.</p>
            </div>
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative my-6" role="alert">
                <strong class="font-bold">¡Ocurrió un error!</strong>
                <span id="error-content" class="block sm:inline">No fue posible generar el reporte. Por favor, intente nuevamente.</span>
            </div>

            <!-- Aviso Legal -->
            <div id="disclaimer-section" style="display: none;" class="mt-10 bg-red-50 p-4 rounded-lg border border-red-300 text-center">
                <h3 class="font-bold text-red-700 text-lg">ATENÇÃO - AVISO IMPORTANTE</h3>
                <p class="text-sm text-red-600 mt-2">
                    As informações neste aplicativo não têm a intenção de ser aconselhamento profissional nem têm a intenção de substituir uma consulta pessoal com um médico, farmacêutico ou outro profissional de saúde qualificado. O leitor não deve desconsiderar aconselhamento médico nem adiar a busca por aconselhamento médico devido a alguma informação encontrada neste aplicativo.
                </p>
            </div>

            <!-- Seção do Relatório Gerado -->
            <div id="report-output" style="display: none;" class="mt-4 bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <!-- Abas de Navegação -->
                <div class="tab-buttons-container border-b border-gray-200 mb-4">
                    <nav class="tab-buttons -mb-px flex space-x-6" aria-label="Tabs">
                        <button class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="tabla-resumen-section">Resumo dos Resultados</button>
                        <button class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="explicacion-sencilla-section">Explicação Simplificada</button>
                    </nav>
                </div>
                
                <!-- Conteúdo das Abas -->
                <div id="tabla-resumen-section" class="tab-content active">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-teal-600">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Parámetro</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Seu Valor</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Interpretação Geral</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                
                 <div id="explicacion-sencilla-section" class="tab-content">
                    <div id="explicacion-sencilla-content" class="prose max-w-none text-gray-700"></div>
                </div>
            </div>
        </main>

        <footer id="main-footer" class="text-center mt-12 pt-8 border-t border-gray-200 text-sm text-gray-500 max-w-3xl mx-auto">
             <h3 class="text-2xl font-bold text-gray-800 tracking-wide mb-4">MISSIONARY MEDICAL CARE</h3>
             <div class="mt-6 bg-red-50 border border-red-300 rounded-lg p-4">
                <h4 class="font-bold text-red-700">ATENÇÃO - AVISO IMPORTANTE</h4>
                <p class="mt-2 text-sm text-red-600">
                    Este é um serviço informativo e não substitui uma consulta médica. As informações neste aplicativo não têm a intenção de ser aconselhamento profissional nem têm a intenção de substituir uma consulta pessoal com um médico, farmacêutico ou outro profissional de saúde qualificado. O leitor não deve desconsiderar aconselhamento médico nem adiar a busca por aconselhamento médico devido a alguma informação encontrada neste aplicativo.
                </p>
            </div>
             <p class="mt-4">&copy; 2024. Todos los derechos reservados.</p>
        </footer>
    </div>

    <script type="module">
        let reportDataForSharing = null; // Variável global para guardar os dados do relatório

        const generateBtn = document.getElementById('generate-report-btn');
        const clearBtn = document.getElementById('clear-form-btn');
        const printBtn = document.getElementById('print-report-btn');
        const whatsappBtn = document.getElementById('whatsapp-share-btn');
        const labForm = document.getElementById('lab-form');
        
        const loadingSection = document.getElementById('loading-section');
        const errorMessage = document.getElementById('error-message');
        const reportOutput = document.getElementById('report-output');
        const disclaimerSection = document.getElementById('disclaimer-section');

        generateBtn.addEventListener('click', async () => {
            const examText = document.getElementById('exam-text').value;

            if (!examText.trim()) {
                alert("Por favor, cole o texto do seu exame na caixa.");
                return;
            }

            // Esconder seções de resultado e mostrar carregamento
            errorMessage.style.display = 'none';
            reportOutput.style.display = 'none';
            disclaimerSection.style.display = 'none';
            printBtn.style.display = 'none';
            whatsappBtn.style.display = 'none';
            loadingSection.style.display = 'block';
            
            const outrosDados = document.getElementById('outros_dados').value;

            let promptText = `
                Aja como um assistente médico empático explicando resultados de exames para um paciente leigo.
                A partir do texto do exame e dos sintomas fornecidos, faça o seguinte:
                1.  Identifique os principais parâmetros que estão alterados (fora dos valores de referência). Ignore os que estão normais.
                2.  Crie uma tabela resumo APENAS para os itens alterados.
                3.  Escreva uma explicação geral e muito simples sobre o que essas alterações podem significar, sem causar alarme.
                4.  SEMPRE reforce que a interpretação final deve ser feita por um médico e que a ferramenta é apenas informativa.
                A resposta DEVE seguir o formato JSON do schema. O idioma deve ser o mesmo dos dados do paciente (espanhol ou português).

                ## Texto do Exame do Paciente:
                ${examText}

                ## Sintomas/Preocupações do Paciente:
                ${outrosDados || "Nenhum informado."}
            `;
            
            const schema = {
                type: "OBJECT",
                properties: {
                    tablaResumen: { type: "ARRAY", items: { type: "OBJECT", properties: { parametro: { type: "STRING" }, valor: { type: "STRING" }, interpretacion: { type: "STRING" } }, required: ["parametro", "valor", "interpretacion"] } },
                    explicacionSencilla: { type: "STRING" }
                },
                required: ["tablaResumen", "explicacionSencilla"]
            };

            try {
                const apiKey = "AIzaSyBSwG0EMH7kvf7DLo4j280wb42uaWmp_ZA"; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{text: promptText}] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                if (!response.ok) {
                    let errorMsg = `Error de API: ${response.status}.`;
                    const errorBody = await response.json().catch(() => null);
                    if(errorBody && errorBody.error) {
                        errorMsg = errorBody.error.message;
                    }
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                    reportDataForSharing = JSON.parse(result.candidates[0].content.parts[0].text);
                    displayReport(reportDataForSharing);
                } else {
                     throw new Error("La respuesta de la API fue inválida, vacía o não contém a informação esperada.");
                }
            } catch (error) {
                console.error("Error al generar reporte:", error);
                document.getElementById('error-content').textContent = error.message;
                errorMessage.style.display = 'block';
            } finally {
                loadingSection.style.display = 'none';
            }
        });

        clearBtn.addEventListener('click', () => {
            labForm.reset();
            reportOutput.style.display = 'none';
            disclaimerSection.style.display = 'none';
            printBtn.style.display = 'none';
            whatsappBtn.style.display = 'none';
            reportDataForSharing = null;
            window.scrollTo(0, 0);
        });

        printBtn.addEventListener('click', () => {
            window.print();
        });

        whatsappBtn.addEventListener('click', () => {
            if (!reportDataForSharing) return;

            let message = "Olá! Aqui está um resumo da análise do seu exame gerada pelo TELELAB:\n\n";
            message += "*Resultados Alterados:*\n";
            
            if(reportDataForSharing.tablaResumen && reportDataForSharing.tablaResumen.length > 0){
                reportDataForSharing.tablaResumen.forEach(item => {
                    message += `- *${item.parametro}:* ${item.valor} (${item.interpretacion})\n`;
                });
            } else {
                message += "- Nenhum resultado alterado foi identificado.\n";
            }

            message += "\n*Explicação Geral:*\n";
            message += `${reportDataForSharing.explicacionSencilla}\n\n`;
            message += "*AVISO IMPORTANTE:* Este é um resumo informativo gerado por IA e não substitui uma consulta. Por favor, mostre estes resultados ao seu médico para uma avaliação completa.";

            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        });

        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.dataset.tab;
                const target = document.getElementById(targetId);

                tabs.forEach(t => {
                    t.classList.remove('active', 'text-teal-600', 'border-teal-600');
                    t.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
                });
                tab.classList.add('active', 'text-teal-600', 'border-teal-600');
                
                tabContents.forEach(c => c.classList.remove('active'));
                target.classList.add('active');
            });
        });

        function displayReport(data) {
            const tableBody = document.getElementById('summary-table-body');
            tableBody.innerHTML = '';
            if (data.tablaResumen && data.tablaResumen.length > 0) {
                data.tablaResumen.forEach((item, index) => {
                    const bgColor = index % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                    let valueClass = 'text-gray-900';
                    const interp = (item.interpretacion || "").toLowerCase();
                    if (interp.includes('alto') || interp.includes('aumentado') || interp.includes('elevado') || interp.includes('positiv') || interp.includes('reactivo') || interp.includes('>')) {
                        valueClass = 'text-red-600 font-semibold';
                    } else if (interp.includes('bajo') || interp.includes('disminuido') || interp.includes('<')) {
                        valueClass = 'text-blue-600 font-semibold';
                    }
                    const row = `<tr class="${bgColor}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.parametro}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${valueClass}">${item.valor}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${item.interpretacion}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            } else {
                 tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4">Não foram encontradas alterações significativas ou o formato do exame não pôde ser lido. Consulte sempre o seu médico.</td></tr>`;
            }

            document.getElementById('explicacion-sencilla-content').innerHTML = `<h3 class="text-lg font-semibold text-gray-800 mb-2">Entendendo seus resultados:</h3><p>${(data.explicacionSencilla || 'Consulte o seu médico para uma interpretação completa dos seus resultados.').replace(/\n/g, '</p><p>')}</p>`;

            tabs.forEach((btn, index) => {
                btn.classList.toggle('active', index === 0);
            });
            tabContents.forEach((content, index) => {
                content.classList.toggle('active', index === 0);
            });
            
            // Tornar os botões e seções visíveis
            disclaimerSection.style.display = 'block';
            reportOutput.style.display = 'block';
            printBtn.style.display = 'inline-flex';
            whatsappBtn.style.display = 'inline-flex';
            
            reportOutput.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>

